{% extends "layout.html" %}

{% block content %}
<div class="row mb-4 animate-fade-in">
    <div class="col-12">
        <h2 class="section-title"><i class="bi bi-box-seam me-2 text-primary"></i>Resource Management</h2>
    </div>
</div>

<div class="row">
    <!-- Form -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-plus-circle me-2"></i> Add New Resource
            </div>
            <div class="card-body">
                <form id="resource-form">
                    <div class="mb-3">
                        <label class="form-label">Resource Name</label>
                        <input type="text" class="form-control" name="name" required
                            placeholder="e.g. Conference Room A">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Resource Type</label>
                        <input type="text" class="form-control" name="type" required
                            placeholder="e.g. Room, Instructor, Equipment">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-lg me-2"></i> Create Resource
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- List -->
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul me-2"></i> Available Resources</span>
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                    <input type="text" id="resource-search" class="form-control" placeholder="Search...">
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column">
                <div class="table-responsive flex-grow-1">
                    <table class="table table-custom table-hover align-middle mb-0" id="resource-table">
                        <thead>
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th class="text-end pe-4 text-nowrap">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="p-3 border-top bg-light d-flex justify-content-between align-items-center"
                    id="pagination-container">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Resource Modal -->
<div class="modal fade" id="editResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-resource-form">
                    <input type="hidden" name="id" id="edit-resource-id">
                    <div class="mb-3">
                        <label class="form-label">Resource Name</label>
                        <input type="text" class="form-control" name="name" id="edit-resource-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resource Type</label>
                        <input type="text" class="form-control" name="type" id="edit-resource-type" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/main.js"></script>
<script>
    let editModal;
    let currentPage = 1;
    let currentSearch = '';
    const PER_PAGE = 10;

    document.addEventListener('DOMContentLoaded', () => {
        editModal = new bootstrap.Modal(document.getElementById('editResourceModal'));

        // Search Debounce
        let timeout = null;
        document.getElementById('resource-search').addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                currentSearch = e.target.value;
                currentPage = 1;
                loadResources(currentPage, currentSearch);
            }, 300);
        });
    });

    async function loadResources(page = 1, query = '') {
        const tbody = document.querySelector('#resource-table tbody');
        const paginationContainer = document.getElementById('pagination-container');

        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3">Loading...</td></tr>';

        try {
            const data = await apiCall(`/resources?page=${page}&per_page=${PER_PAGE}&q=${encodeURIComponent(query)}`);

            // Handle if data is array (backwards compatibility or error) vs object
            const resources = data.items || [];
            const totalPages = data.pages || 1;

            if (resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3 text-muted">No resources found.</td></tr>';
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }

            tbody.innerHTML = resources.map(r => `
                <tr>
                    <td class="ps-4">${r.id}</td>
                    <td><span class="fw-bold">${r.name}</span></td>
                    <td><span class="badge bg-${r.type.toLowerCase() === 'room' ? 'primary' : 'secondary'}">${r.type}</span></td>
                    <td class="text-end pe-4 text-nowrap table-actions">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(${r.id}, '${r.name}', '${r.type}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteResource(${r.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Render Pagination
            if (paginationContainer) {
                if (totalPages > 1) {
                    renderPagination(data.current_page, totalPages);
                } else {
                    paginationContainer.innerHTML = ''; // Hide if single page
                }
            }

        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-danger p-3">${e.message}</td></tr>`;
        }
    }

    function renderPagination(current, total) {
        const container = document.getElementById('pagination-container');

        let paginationHTML = `
            <small class="text-muted">Page ${current} of ${total}</small>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item ${current === 1 ? 'disabled' : ''}">
                        <button class="page-link" type="button" onclick="changePage(${current - 1})">Previous</button>
                    </li>
        `;

        // Simple Pagination Logic
        for (let i = 1; i <= total; i++) {
            if (i === 1 || i === total || (i >= current - 1 && i <= current + 1)) {
                paginationHTML += `
                    <li class="page-item ${i === current ? 'active' : ''}">
                        <button class="page-link" type="button" onclick="changePage(${i})">${i}</button>
                    </li>
                 `;
            } else if (i === current - 2 || i === current + 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        paginationHTML += `
                    <li class="page-item ${current === total ? 'disabled' : ''}">
                        <button class="page-link" type="button" onclick="changePage(${current + 1})">Next</button>
                    </li>
                </ul>
            </nav>
        `;

        container.innerHTML = paginationHTML;
    }

    window.changePage = (page) => {
        currentPage = page;
        loadResources(currentPage, currentSearch);
    };

    // Create
    document.getElementById('resource-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            await apiCall('/resources', 'POST', data);
            showAlert('Resource created!');
            e.target.reset();
            loadResources(currentPage, currentSearch);
        } catch (err) {
            showAlert(err.message, 'danger');
        }
    });

    // Edit Flow
    window.openEdit = (id, name, type) => {
        document.getElementById('edit-resource-id').value = id;
        document.getElementById('edit-resource-name').value = name;
        document.getElementById('edit-resource-type').value = type;
        editModal.show();
    };

    document.getElementById('edit-resource-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-resource-id').value;
        const name = document.getElementById('edit-resource-name').value;
        const type = document.getElementById('edit-resource-type').value;

        try {
            await apiCall(`/resources/${id}`, 'PUT', { name, type });
            showAlert('Resource updated successfully');
            editModal.hide();
            loadResources(currentPage, currentSearch);
        } catch (err) {
            showAlert(err.message, 'danger');
        }
    });

    // Delete Flow
    window.deleteResource = async (id) => {
        if (!confirm('Are you sure? This will delete all allocations for this resource.')) return;
        try {
            await apiCall(`/resources/${id}`, 'DELETE');
            showAlert('Resource deleted');
            loadResources(currentPage, currentSearch);
        } catch (err) {
            showAlert(err.message, 'danger');
        }
    };

    loadResources();
</script>
{% endblock %}